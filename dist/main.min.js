var App = function() {
    var a = {
        lines: [ {
            name: "1",
            stations: [ {
                name: "Les Jardins de l’Hôpital",
                directions: [ [ "7:44", "9:07", "9:52", "11:02", "12:25", "13:17", "14:45", "16:25", "17:15", "18:05" ], [ "7:27", "8:09", "9:32", "10:17", "11:27", "12:50", "13:42", "15:14", "16:50", "17:40", "18:30" ] ]
            }, {
                name: "Parrine Basse",
                directions: [ [ "7:45", "7:45", "9:08", "9:53", "11:03", "12:26", "13:18", "14:46", "16:26", "17:16", "18:06" ], [ "7:26", "8:08", "9:31", "10:16", "11:26", "12:49", "13:41", "15:13", "16:49", "17:39", "18:29" ] ]
            }, {
                name: "Pons",
                directions: [ [ "7:46", "9:09", "9:54", "11:04", "12:27", "13:19", "14:47", "16:27", "17:17", "18:07" ], [ "7:25", "8:07", "9:30", "10:15", "11:25", "12:48", "13:40", "15:12", "16:48", "17:38", "18:28" ] ]
            }, {
                name: "Tillet",
                directions: [ [ "7:46", "9:09", "9:54", "11:04", "12:27", "13:19", "14:47", "16:27", "17:17", "18:07" ], [ "7:25", "8:07", "9:30", "10:15", "11:25", "12:48", "13:40", "15:12", "16:48", "17:38", "18:28" ] ]
            }, {
                name: "Pinquié",
                directions: [ [ "7:47", "9:10", "9:55", "11:05", "12:28", "13:20", "14:48", "16:28", "17:18", "18:08" ], [ "7:24", "8:06", "9:29", "10:14", "11:24", "12:47", "13:39", "15:11", "16:47", "17:37", "18:27" ] ]
            }, {
                name: "Centre des Impôts",
                directions: [ [ "7:47", "9:10", "9:55", "11:05", "12:28", "13:20", "14:48", "16:28", "17:18", "18:08" ], [ "7:24", "8:06", "9:29", "10:14", "11:24", "12:47", "13:39", "15:11", "16:47", "17:37", "18:27" ] ]
            }, {
                name: "Les Miattes",
                directions: [ [ "7:48", "9:11", "9:56", "11:06", "12:29", "13:21", "14:49", "16:29", "17:19", "18:09" ], [ "7:23", "8:05", "9:28", "10:13", "11:23", "12:46", "13:38", "15:10", "16:46", "17:36", "18:26" ] ]
            }, {
                name: "La Pintre",
                directions: [ [ "7:50", "9:13", "9:58", "11:08", "12:31", "13:23", "14:51", "16:31", "17:21", "18:11" ], [ "7:21", "8:03", "9:26", "10:11", "11:21", "12:44", "13:36", "15:08", "16:44", "17:34", "18:24" ] ]
            }, {
                name: "Gendarmerie",
                directions: [ [ "7:50", "9:13", "9:58", "11:08", "12:31", "13:23", "14:51", "16:31", "17:21", "18:11" ], [ "7:21", "8:03", "9:26", "10:11", "11:21", "12:44", "13:36", "15:08", "16:44", "17:34", "18:24" ] ]
            }, {
                name: "I.U.T.",
                directions: [ [ "7:53", "9:16", "10:01", "11:11", "12:34", "13:26", "14:54", "16:34", "17:24", "18:14" ], [ "7:18", "8:00", "9:23", "10:08", "11:18", "12:41", "13:33", "15:05", "16:41", "17:31", "18:21" ] ]
            }, {
                name: "Ecureuils",
                directions: [ [ "7:55", "9:18", "10:03", "11:13", "12:36", "13:28", "14:56", "16:36", "17:26", "18:16" ], [ "7:16", "7:58", "9:21", "10:06", "11:16", "12:39", "13:31", "15:03", "16:39", "17:29", "18:19" ] ]
            }, {
                name: "Genevriers",
                directions: [ [ "7:56", "9:19", "10:04", "11:14", "12:37", "13:29", "14:57", "16:37", "17:27", "18:17" ], [] ]
            }, {
                name: "Nayrac",
                directions: [ [ "7:57", "9:20", "10:05", "11:15", "12:38", "13:30", "14:58", "16:38", "17:28", "18:18" ], [ "7:15", "7:57", "9:20", "10:05", "11:15", "12:38", "13:30", "15:02", "16:38", "17:28", "18:18" ] ]
            } ]
        }, {
            name: "2 (future)",
            stations: []
        }, {
            name: "3 (future)",
            stations: []
        } ]
    }, b = {
        lines: null,
        stations: null
    }, c = {
        line: null,
        direction: null,
        station: null
    }, d = function() {
        b.lines = $("#form-select-lines"), b.directionsToggle = $("#form-direction-toggle"), 
        b.direction1 = $("#form-direction-1"), b.direction2 = $("#form-direction-2"), b.stations = $("#form-select-stations"), 
        b.timetable = $("#form-table-timetable"), e(), g();
    }, e = function() {
        for (var d = 0; d < a.lines.length; d++) {
            var e = a.lines[d];
            b.lines.append(HtmlGenerator.createLineOptionElement(e, d));
        }
        c.line = a.lines[0], h(c.line);
    }, f = function() {
        b.stations.html("");
        var a, d;
        if (0 === c.direction) for (d = 0; d < c.line.stations.length; d++) a = c.line.stations[d], 
        b.stations.append(HtmlGenerator.createStationOptionElement(a, d)); else if (1 === c.direction) for (d = c.line.stations.length - 1; d >= 0; d--) a = c.line.stations[d], 
        b.stations.append(HtmlGenerator.createStationOptionElement(a, d));
    }, g = function() {
        b.lines.on("change", function(b) {
            var d = $(this).val();
            c.line = a.lines[d], h(c.line);
        }), b.stations.on("change", function(a) {
            var d = $(this).val();
            c.station = c.line.stations[d], i(c.station), l(b.directionsToggle.parent().prev());
        }), b.directionsToggle.on("click", function(a) {
            j();
        });
    }, h = function(a) {
        k();
        var d = c.line.stations[0], e = c.line.stations[c.line.stations.length - 1];
        b.direction1.html(d.name), b.direction1.attr("data-direction", 0), b.direction2.html(e.name), 
        b.direction2.attr("data-direction", 1), c.direction = 0, f(), c.station = c.line.stations[0], 
        i(c.station);
    }, i = function(a) {
        b.timetable.html("");
        for (var d = a.directions[c.direction], e = 0; e < d.length; e++) {
            var f = d[e];
            b.timetable.append(HtmlGenerator.createTableRowTimeElement(f, e));
        }
        b.timetable.find("tr.hidden").size() === d.length && (b.timetable.append('<tr class="warning"><td colspan="2"><h5 class="text-center">No more busses today!</h5></td></tr>'), 
        b.timetable.append('<tr><td colspan="2"><p class="text-center">Check again tomorrow or load the <a class="form-load-full-timetable">full timetable</a>.</p></td></tr>'), 
        $(".form-load-full-timetable").on("click tab", function() {
            b.timetable.find("tr").removeClass("hidden"), $(this).parent().parent().remove(), 
            l(b.timetable.prev());
        }));
    }, j = function() {
        var a = b.direction1.html(), d = b.direction1.attr("data-direction"), e = b.direction2.html(), g = b.direction2.attr("data-direction");
        c.direction = parseInt(g), b.direction1.html(e), b.direction1.attr("data-direction", g), 
        b.direction2.html(a), b.direction2.attr("data-direction", d), f();
        var h = b.stations.find('option:contains("' + c.station.name + '")').val();
        b.stations.val(h), i(c.station);
    }, k = function() {
        b.stations.html(""), b.timetable.html("");
    }, l = function(a) {
        $("html, body").animate({
            scrollTop: a.offset().top
        }, 500);
    };
    return {
        init: d,
        data: a
    };
}();

$(document).ready(function() {
    App.init();
});

var HtmlGenerator = function() {
    var a = function(a, b) {
        var c = $("<option></option>");
        return c.val(b), c.html("Line: " + a.name), 0 === a.stations.length && c.attr("disabled", "disabled"), 
        c;
    }, b = function(a, b) {
        var c = $("<option></option>");
        return c.val(b), c.html(a.name), c;
    }, c = function(a, b) {
        var c = $("<tr></tr>"), d = $("<td></td>");
        d.html(a);
        var e = $("<td></td>"), f = moment(), g = moment(), h = a.split(":");
        if (g.set("hours", h[0]), g.set("minutes", h[1]), f.isAfter(g)) e.html("arrived " + g.fromNow()), 
        c.addClass("hidden"); else {
            var i = g.diff(f);
            3 >= i / 6e4 ? c.addClass("danger") : 10 >= i / 6e4 ? c.addClass("warning") : 30 >= i / 6e4 && c.addClass("success"), 
            e.html(g.fromNow());
        }
        return c.append(d), c.append(e), c;
    };
    return {
        createLineOptionElement: a,
        createStationOptionElement: b,
        createTableRowTimeElement: c
    };
}();